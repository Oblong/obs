#!/bin/sh
# Sets persistant source options in debian directory.
#
# Run to select a different version of g-speak or change cmake options.
# NOTE: use --hard if you want to change default g-speak version in git!
#
# Generic, should work for most projects that depend on g-speak.
# However, if your project needs different behavior, you have two choices:
# 1) Override this script entirely by creating the file set-gspeak.sh
# at the top of your project and putting your private version there.
# 2) Tweak defaults by defining the file ci/ob-set-defaults.conf
# containing lines like
#    PREFIX=/opt/oblong/my-funky-dir
# (see Tweakable Defaults below)

usage() {
    cat <<_EOF_
Usage: ob-set-defaults [options]
Sets default generic build parameters for this project.
Sticky options:
  --cef branch   - which version of cef to build against (sticky)
  --g-speak VER  - which version of g-speak to build against (sticky)
  --mezz VER     - which version of mezzanine to build against (sticky)
Options:
  -v             - verbose
  --hard         - use 'git mv' instead of 'mv' when renaming debian files
  --asan         - alias for -DASAN=on
  --coverage     - alias for -DCOVERAGE=on
  --debug        - alias for -DCMAKE_BUILD_TYPE=Debug
  --greenhouse   - alias for -DUSE_STATIC_G_SPEAK=on -DG_SPEAK_HOME=/opt/oblong/greenhouse, hobbles plasma, adds -gh package suffixes
  --make         - generate Makefiles and build with make
  --ninja        - generate build.ninja and build with ninja
  --no-tests     - alias for -DBUILD_TESTS=off
  --prefix DIR   - where to install
  --rel          - alias for -DCMAKE_BUILD_TYPE=Release
  --reldeb       - alias for -DCMAKE_BUILD_TYPE=ReleaseWithDebInfo
  --tsan         - alias for -DTSAN=on
  --xcode        - generate XCode project and build with XCode
  --no-major     - don't append major version number to package name
  --major N      - append given major version number to package name
  -Dfoo=bar      - passed through to cmake with doublequotes

--cef, --g-speak, and --mezz are 'sticky', and keep their value on next run
even if you don't specify them again.

If this command renames files in the debian directory, it will
tell you, and remind you about the --hard option (which can save
you trouble when committing).
_EOF_
}

# Project defined a set-mezzanine.sh, so call that instead.
fallback_to_classic_mezzanine() {
    echo "Found local set-mezzanine.sh, running that instead"

    # Adjust args to match old interface
    local verbose
    local mezz_version
    while true
    do
       case "$1" in
       -v)         verbose=-x;;
       --mezz)  shift; mezz_version=$1;;
       --hard)
           # makes --g-speak more emphatic and check-in-able
           # Let caller specify it via 'GITCMD=git' for backward compatibility
           export GITCMD=git
           ;;
       *) break;;
       esac
       shift
    done
    exec sh $verbose set-mezzanine.sh "$mezz_version" "$@"
}

# Project defined a set-gspeak.sh, so call that instead.
# Restriction: -v and/or --g-speak must come first.
fallback_to_classic() {
    echo "Found local set-gspeak.sh, running that instead"

    # Adjust args to match old interface
    local verbose
    local gspeak_version
    while true
    do
       case "$1" in
       -v)         verbose=-x;;
       --g-speak)  shift; gspeak_version=$1;;
       --hard)
           # makes --g-speak more emphatic and check-in-able
           # Let caller specify it via 'GITCMD=git' for backward compatibility
           export GITCMD=git
           ;;
       *) break;;
       esac
       shift
    done
    exec sh $verbose set-gspeak.sh "$gspeak_version" "$@"
}

# Let project override by defining set-gspeak.sh (as in days of yore)
case "$*" in
*--g-speak*)
  if test -f set-gspeak.sh
  then
    fallback_to_classic "$@"
  fi
  ;;
*--mezz*)
  if test -f set-mezzanine.sh
  then
    fallback_to_classic_mezzanine "$@"
  fi
  ;;
esac

# Give help before doing anything that might fail
case "$1" in
""|-h|--help|help) usage; exit 0;;
esac

# This is part of oblong's obs package
# See https://github.com/Oblong/obs
. obs_funcs.sh

set -e

case "$(uname -s)" in
Darwin) sed=gsed; if ! gsed --version; then bs_abort "please install gnu-sed"; fi;;
*) sed=sed;;
esac

# Tweakable Defaults
# The defaults that can be overridden by ob-set-defaults.conf
gspeak_version=""
mezz_version=""
G_SPEAK_HOME=""
PREFIX=""
cefbranch=""
extra_cmake_options=""
opt_generator="Ninja"
opt_no_major=false
suffix=""

# Load project-specific defaults, if any
if test -f ci/ob-set-defaults.conf
then
    echo "Loading ci/ob-set-defaults.conf"
    . ci/ob-set-defaults.conf
fi

while test "$1" != ""
do
    case "$1" in
    -v) set -x
        ;;
    --greenhouse)   # should be sticky, but is seldom used
        # In project greenhouse, also need to specify --prefix /opt/oblong/greenhouse to match old set-gspeak.sh behavior
        suffix="-gh"
        # everybody's set-gspeak took --greenhouse to mean G_SPEAK_HOME=/opt/oblong/greenhouse PREFIX=/opt/oblong/greenhouse
        G_SPEAK_HOME=/opt/oblong/greenhouse
        # yovo and staging's cmake needed -DGREENHOUSE=on; everyone else's cmake needs -DUSE_STATIC_G_SPEAK=on
        extra_cmake_options="$extra_cmake_options -DUSE_STATIC_G_SPEAK=on -DGREENHOUSE=on"
        ;;
    --g-speak)
        shift
        gspeak_version=$1
        ;;
    --mezz)
        shift
        mezz_version=$1
        ;;
    --hard)
        # makes --g-speak more emphatic and check-in-able
        # Let caller specify it via 'GITCMD=git' for backward compatibility
        GITCMD=git
        ;;
    -D*!*)
        echo "Sorry, exclamation marks and embedded single quotes are not supported here in cmake options"
        exit 1
        ;;
    -D*)
        extra_cmake_options="$extra_cmake_options '$1'"
        ;;
    --asan)
        extra_cmake_options="$extra_cmake_options -DASAN=on"
        ;;
    --cef)
        shift
        cefbranch=cef$1
        ;;
    --coverage)
        extra_cmake_options="$extra_cmake_options -DCOVERAGE=on"
        ;;
    --debug)
        extra_cmake_options="$extra_cmake_options -DCMAKE_BUILD_TYPE=Debug"
        ;;
    --rel)
        extra_cmake_options="$extra_cmake_options -DCMAKE_BUILD_TYPE=Release"
        ;;
    --reldeb)
        extra_cmake_options="$extra_cmake_options -DCMAKE_BUILD_TYPE=ReleaseWithDebInfo"
        ;;
    --major)
        shift
        opt_major="$1"
        ;;
    --make)
        opt_generator="Unix Makefiles"
        ;;
    --ninja)
        opt_generator="Ninja"
        ;;
    --no-major)
        opt_no_major=true
        ;;
    --prefix)
        shift
        PREFIX="$1"
        ;;
    --vs)
        opt_toolchain=$(bs_detect_toolchain)
        case $opt_toolchain in
        msvc2010) opt_generator="Visual Studio 10 2010";;
        msvc2013) opt_generator="Visual Studio 12 2013";;
        msvc2015) opt_generator="Visual Studio 14 2015";;
        *) bs_abort "ob-set-defaults: unknown compiler $opt_toolchain";;
        esac
        ;;
    --xcode)
        opt_generator="Xcode"
        ;;
    --no-tests)
        extra_cmake_options="$extra_cmake_options -DBUILD_TESTS=off"
        ;;
    *)
        usage
        exit 1
        ;;
    esac
    shift
done

# The version-changing options are sensitive to debris left
# behind in the debian directory by builds, so abort early
# if that's likely to be a problem.
if test "$mezz_version" != "" || test "$gspeak_version" != ""
then
    if ls debian/*.bak 2>/dev/null || ls debian/*.debhelper 2>/dev/null
    then
        bs_abort "Please remove debris (e.g. .bak, .debhelper) from debian directory, e.g. with 'bau clean', 'git clean -f', and/or 'dh clean'"
    fi
fi

BITS=$(getconf LONG_BIT)
if test "$gspeak_version" = ""
then
    # Keep old version, if any, as this is a sticky option
    gspeak_version=$(bs_get_gspeak_version)
fi
YOVERSION=$(bs_yovo2yoversion "$gspeak_version")
YOBUILD=/opt/oblong/deps-$BITS-$YOVERSION
if test "$YOVERSION" = ""
then
    bs_abort "ob-set-defaults: YOVERSION is empty?"
fi
if test "$G_SPEAK_HOME" = ""
then
    G_SPEAK_HOME=/opt/oblong/g-speak$gspeak_version
fi
if test "$PREFIX" = ""
then
    PREFIX=$G_SPEAK_HOME
fi
if test "$cefbranch" = ""
then
    # Keep old version, if any, as this is a sticky option
    if ! cefbranch=$(bs_get_cef_version) || test "$cefbranch" = ""
    then
        cefbranch=$(bs_yovo2cefversion "$gspeak_version" || true)
    fi
fi

pkgname=$(awk '/Source:/ {print $2};' < debian/control)
projname=$(echo "$pkgname" | $sed 's/-gs.*//;s/-gh//;')

if test "$opt_major" != ""
then
    version_major="$opt_major"
elif $opt_no_major
then
    version_major=""
else
    # Allow multiple major versions of this package to coexist in repo by using major version number as suffix on package name
    version_major=$(bs_get_major_version_git)
fi

# Set g-speak version number, and major version number for this project, in debian/* files.
# This sed should catch all Oblong projects.
# New projects must use the gsX.Yx convention in their package names to make this easy
# Legacy packages are listed here explicitly, e.g. one for each Package: line in yovo/debian/control.in
# g-speak version number parsing:
# \(-gh\)\{0,1\} means 'match zero or one occurrances of the string -gh'
# [1-9]\.[1-9][0-9]* means 'match version numbers with a nonzero digit, a period, a nonzero digit, and maybe more digits'
# yobuild and cef version number parsing:
# [1-9][0-9]* means 'match version numbers which are whole numbers greater than zero'
#
# About STOP-SUBSTITUTION:
# The oblong-mezzanine-updaterX.Y package includes a long list of Breaks/Replaces
# so that it will uninstall the old mezzanine before a new one is installed.
# set-gspeak.sh and set-mezzanine.sh should not replace those version numbers.
# There is a special line in mezzanine/debian/control with the string
# STOP-SUBSTITUTION which tells sed below to stop there.
#
# About ${SKIP-SUBSTITUTION}:
# We want to be able to substitute g-speak versions
# across many places but we also want to leave it alone
# in some very specific places. So we use the string
# SKIP-SUBSTITUTION to tell sed skip such lines.
# We wrap it in ${} so that debian tools ignore it.
# Example:
# Breaks: liboblong-sidereal-dev,
#         liboblong-sidereal-gs3.27x0-dev, ${SKIP-SUBSTITUTION},
# forces ob-set-defaults to not change the g-speak reference on that line.
#
# Handling both STOP-SUBSTITUTION and SKIP-SUBSTITUTION with sed
# requires the {} feature of gnu sed, whee!

# Tell shellcheck to not complain about possible spaces in output of $(ls debian...)
# shellcheck disable=2046

$sed -i \
    -e "1,/STOP-SUBSTITUTION/ {/SKIP-SUBSTITUTION/! s/${projname}-gs\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*x[0-9]*/${projname}-gs$suffix${gspeak_version}x$version_major/g}" \
    -e "1,/STOP-SUBSTITUTION/ {/SKIP-SUBSTITUTION/! s/gs\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*x/gs$suffix${gspeak_version}x/g}" \
    -e "1,/STOP-SUBSTITUTION/ s/g-speak\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/g-speak$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/g-speak-core\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/g-speak-core$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/g-speak-deps\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/g-speak-deps$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/g-speak-gst-plugins\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/g-speak-gst-plugins$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-afferent\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-afferent$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-basement\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-basement$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-impetus\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-impetus$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-loam\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-loam$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-loam++\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-loam++$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-media\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-media$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-noodoo\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-noodoo$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma++\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma++$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma-gstreamer\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma-gstreamer$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma-ruby\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma-ruby$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma-server\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma-server$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma-zeroconf\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma-zeroconf$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-plasma-zeroconf-server\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-plasma-zeroconf-server$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-cthulhu\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-cthulhu$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-event-slurper\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-event-slurper$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-ganglia\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-ganglia$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-inogeni\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-inogeni$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-netfetch\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-netfetch$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-ouija\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-ouija$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-protist\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-protist$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-quartermaster\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-quartermaster$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-tile-daemon\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-tile-daemon$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-ventriloquy\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-ventriloquy$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-projects-video\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-projects-video$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-rtsp-viddle-server[1-9]\.[0-9][0-9]*/oblong-rtsp-viddle-server$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-staging\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-staging$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-system-protist\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-system-protist$suffix$gspeak_version/g" \
    -e "1,/STOP-SUBSTITUTION/ s/oblong-yobuild[0-9]*/oblong-yobuild$YOVERSION/" \
    -e "1,/STOP-SUBSTITUTION/ s/deps-[0-9]*-[0-9]*/deps-$BITS-$YOVERSION/" \
    -e "1,/STOP-SUBSTITUTION/ s/-cef[1-9][0-9]*/-${cefbranch}/g" \
    -e "1,/STOP-SUBSTITUTION/ s/-mz[1-9][0-9]*/-mz${mezz_version}/g" \
    -e "1,/STOP-SUBSTITUTION/ s,^YOBUILD=.*,YOBUILD=$YOBUILD," \
    -e "1,/STOP-SUBSTITUTION/ s,^G_SPEAK_HOME *=.*,G_SPEAK_HOME=$G_SPEAK_HOME," \
    -e "1,/STOP-SUBSTITUTION/ s,^PREFIX=.*,PREFIX=$PREFIX," \
    -e "1,/STOP-SUBSTITUTION/ s!^EXTRA_CMAKE_OPTIONS=.*!EXTRA_CMAKE_OPTIONS=$extra_cmake_options!" \
    -e "1,/STOP-SUBSTITUTION/ s,^CMAKE_GENERATOR=.*,CMAKE_GENERATOR=$opt_generator," \
    debian/rules \
    debian/control \
    $(ls \
      debian/.gitignore \
      debian/*.alternatives \
      debian/*.install \
      debian/*.lintian-overrides \
      debian/*.postinst \
      debian/*.postrm \
      debian/*.preinst \
      debian/*.prerm \
      debian/*.service \
      debian/*.upstart \
      2>/dev/null) \
    #

# Only want to change 1st line of changelog
$sed -i \
    -e "1s/${projname}-gs\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*x[0-9]*/${projname}-gs$suffix${gspeak_version}x$version_major/g" \
    -e "1s/-cef[1-9][0-9]*/-${cefbranch}/g" \
    -e "1s/oblong-yobuild[0-9]*/oblong-yobuild$YOVERSION/" \
    -e "1s/oblong-rtsp-viddle-server\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-rtsp-viddle-server$suffix$gspeak_version/g" \
    -e "1s/oblong-staging\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/oblong-staging$suffix$gspeak_version/g" \
    -e "1s/g-speak\(-gh\)\{0,1\}[1-9]\.[0-9][0-9]*/g-speak$suffix${gspeak_version}/g" \
    debian/changelog \
    #

# Update the version numbers in all instances of the above filenames in the debian directory
moved=false
for from in \
    debian/*.alternatives \
    debian/*.install \
    debian/*.lintian-overrides \
    debian/*.postinst \
    debian/*.postrm \
    debian/*.preinst \
    debian/*.prerm \
    debian/*.service \
    debian/*.upstart \
    #
do
    if test -f "$from"
    then
        # Traditional g-speak package names (like oblong-staging or oblong-loam) need special handling.
        # These packages can be recognized as follows:
        # - they contain the words oblong or g-speak
        # - they do not contain two embedded version numbers
        # - they do not contain the patterns -gs[1-9] or -gs-gh[0-9]
        # - they do not contain the patterns mezzanine, ob-http-ctl, oblong-mip, oblong-mzreach,
        #   oblong-whiteboard, or oblong-ir-inertial-admin-applications
        if echo "$from" | grep -qE -e 'oblong|g-speak' &&
           ! echo "$from" | grep -qE -e '[0-9].*[-a-z].*[0-9]' &&
           ! echo "$from" | grep -qE -e '-gs[1-9]|-gs-gh[0-9]' &&
           ! echo "$from" | grep -qE -e 'mezzanine|ob-http-ctl|oblong-mip|oblong-mzreach|oblong-whiteboard|oblong-ir-inertial-admin-applications' \
           #
        then
           # It's a traditional g-speak package name.  The only number
           # in it is the g-speak version number, and it is at the end.
           traditional_gspeak_pkg=$(basename "$from" | sed -e 's/[0-9].*//' -e 's/-gh//')
        else
           traditional_gspeak_pkg=xyzzy-no-match
        fi

        # Traditional mezzanine package names need special handling, but only if we're changing the mezzanine version.
        # These packages can be recognized as follows:
        # - they contain the patterns mezzanine, ob-http-ctl, oblong-mip, oblong-mzreach,
        #   oblong-whiteboard, or oblong-ir-inertial-admin-applications
        # - they do not contain two embedded version numbers
        # - they do not contain the patterns -gs[1-9] or -gs-gh[0-9]
        # - they do not contain the word g-speak
        if test "$mezz_version" != "" &&
           echo "$from" | grep -qE -e 'mezzanine|ob-http-ctl|oblong-mip|oblong-mzreach|oblong-whiteboard|oblong-ir-inertial-admin-applications' &&
           ! echo "$from" | grep -qE -e '[0-9].*[-a-z].*[0-9]' &&
           ! echo "$from" | grep -qE -e '-gs[1-9]|-gs-gh[0-9]' &&
           ! echo "$from" | grep -qE -e 'g-speak' \
           #
        then
           # It's a traditional mezzanine package name.  The only number
           # in it is the mezzanine version number, and it is at the end.
           traditional_mezz_pkg=$(basename "$from" | sed -e 's/[0-9].*//')
        else
           traditional_mezz_pkg=xyzzy-no-match
        fi

        to="$(echo "$from" | $sed \
           -e "s/-gs\(-gh\)\{0,1\}[1-9]\\.[0-9][0-9]*x[0-9]*/-gs${suffix}${gspeak_version}x${version_major}/" \
           -e "s/$traditional_gspeak_pkg\(-gh\)\{0,1\}[1-9]\\.[0-9][0-9]*/${traditional_gspeak_pkg}${suffix}${gspeak_version}/" \
           -e "s/$traditional_mezz_pkg[1-9]\\.[0-9][0-9]*/${traditional_mezz_pkg}${mezz_version}/" \
           -e "s/-cef[1-9][0-9]*/-${cefbranch}/;s/yobuild[0-9]*/yobuild$YOVERSION/" \
          #
        )"
        if test "$from" != "$to"
        then
            # Leave GITCMD empty when just building, set it to git when renaming in anger
            $GITCMD mv "$from" "$to"
            moved=true
            movedcmd="mv $from $to"
        fi
    fi
done

# FIXME: can this be simplified as the file renames were?

# Don't do (most) mezzanine version processing unless explicitly called for
if test "$mezz_version" != ""
then
  # This should be a complete list of all packages (minus -dbg) on the mezzanine train,
  # in alphabetical order.
  # This is fragile, and needs to be updated every time we add a package.
  # To remove the fragility and hardcoding, and get rid of the list, there
  # are two options:
  # 1) change code to use oblong-mezzanine*2.7 instead.  Hard to get right.
  # 2) move the mezz version number to immediately after oblong-mezzanine,
  #    so packages are named e.g. oblong-mezzanine2.7-mip
  #    This would make life SO MUCH EASIER I would CRY TEARS OF JOY
  # 2 is probably the right option.  To make the transition easy, we could
  # make this script automatically switch conventions above a certain
  # mezzanine version number.  One-way conversion from old to new is
  # probably sufficient.  Of course, project buy-in would be vital.
  packages="
    mezzanine2.7
    ob-http-ctl2.7
    oblong-ir-inertial-admin-applications2.7
    oblong-mezzanine2.7
    oblong-mezzanine-admin-web2.7
    oblong-mezzanine-appliance2.7
    oblong-mezzanine-deps2.7
    oblong-mezzanine-extras2.7
    oblong-mezzanine-full2.7
    oblong-mezzanine-full-amd2.7
    oblong-mezzanine-init2.7
    oblong-mezzanine-kipple2.7
    oblong-mezzanine-lightbox2.7
    oblong-mezzanine-ob-http-ctl2.7
    oblong-mezzanine-plymouth2.7
    oblong-mezzanine-screencast-payload-mac2.7
    oblong-mezzanine-screencast-payload-win2.7
    oblong-mezzanine-screencast-provisioner2.7
    oblong-mezzanine-screenshare-provisioner2.7
    oblong-mezzanine-updater2.7
    oblong-mezzanine-user-docs-videos2.7
    oblong-mezzanine-user-docs-www2.7
    oblong-mezzanine-web2.7
    oblong-mip2.7
    oblong-mzreach-www2.7
    oblong-whiteboard2.7
  "

  # About STOP-SUBSTITUTION:
  # The oblong-mezzanine-updaterX.Y package includes a long list of Breaks/Replaces
  # so that it will uninstall the old mezzanine before a new one is installed.
  # set-gspeak.sh and set-mezzanine.sh should not replace those version numbers.
  # There is a special line in debian/control with the string STOP-SUBSTITUTION
  # which tells sed below to stop there.

  # Assume we don't need to handle -dbg packages separately
  for package in $packages
  do
      # Update the version number in all instances of the above packages
      # in file bodies in the debian directory
      from=$(echo "$package" | $sed 's/2.7/[1-9].[0-9][0-9]*/')
      to=$(echo "$package" | $sed "s/2.7/$mezz_version/")
      $sed -i \
          -e "1,/STOP-SUBSTITUTION/ s/$from/$to/g" \
          debian/control debian/rules debian/changelog debian/.gitignore \
          $(ls debian/*.lintian-overrides debian/*.postinst debian/*.prerm debian/*.upstart debian/*.service debian/.gitignore 2>/dev/null) \
          #
  done
fi

if $moved && test "$GITCMD" = ""
then
    bs_warn "ob-set-defaults: Files renamed (e.g. $movedcmd), but --hard not given, so 'git mv' not used."
    bs_warn "ob-set-defaults: Undo, then rerun with --hard if you want to check changes in to git."
fi
